## üß† Core Windows Processes & Sysinternals Tools

### ü™ü Core Windows Processes

Before analyzing Windows logs and investigating threats, it's essential to understand legitimate background processes in Windows.

#### üìã Task Manager

- **Task Manager** is a GUI utility that shows all active processes and resource usage.
- Commonly used to kill unresponsive programs.
- Helps visualize **parent-child relationships** between processes.

![[Pasted image 20250615103432.png]]
    
#### ‚úÖ Legitimate Core Processes

| Process        | Notes                                                                        |
| -------------- | ---------------------------------------------------------------------------- |
| `System`       | Kernel process, should only have `System Idle Process (PID 0)` as its parent |
| `smss.exe`     | Session Manager Subsystem ( child of `System` )                              |
| `csrss.exe`    | Client/Server Runtime Subsystem                                              |
| `wininit.exe`  | Windows Initialization                                                       |
| `services.exe` | Manages services (child of `wininit.exe`)                                    |
| `svchost.exe`  | Generic host process for services (child of `services.exe`)                  |
| `lsass.exe`    | Local Security Authority Subsystem Service                                   |
| `winlogon.exe` | Manages login sessions                                                       |
| `explorer.exe` | GUI shell                                                                    |

üß† **Tip**: Any of these processes appearing without their correct parent or launched from unusual paths is suspicious.


### üõ†Ô∏è Sysinternals Suite

Sysinternals is a suite of 70+ tools for Windows diagnostics and troubleshooting.

#### üß≠ Categories

- File & Disk Utilities
- Networking Utilities
- Process Utilities
- Security Utilities
- System Information
- Miscellaneous
    

#### üåê TCPView (Networking Utility)

> Shows **TCP/UDP endpoints**, **local/remote IPs**, **states**, and **owning process names**.

- Better visual alternative to `netstat`
- CLI version: `tcpvcon`

‚úÖ **Use Case**:
- See which process initiated suspicious outbound/inbound connections.

![[Pasted image 20250615103447.png]]
    
#### ‚öôÔ∏è Process Explorer (Process Utility)

> Displays running processes, parent-child tree, memory, DLLs, handles, and services.

- **Top Pane**: Active processes with account info
- **Bottom Pane**:
    - Handle mode: Opened files/directories
    - DLL mode: Loaded DLLs and memory-mapped files
        

‚úÖ **Use Case**:
- Investigate DLL injection, malicious process chains, and file access behavior
    

![[Pasted image 20250615103459.png]]

### üìñ Story: Mira and the Phantom Process

Mira was handed a suspicious PC by a colleague. ‚ÄúSomething‚Äôs off,‚Äù he said, ‚Äúbut antivirus shows nothing.‚Äù

She launched **Task Manager** and scanned the process list.

Everything looked fine at first... `wininit.exe`, `services.exe`, `svchost.exe`. But her eyes narrowed when she saw `lsass.exe` ‚Äî running **without a parent**.

‚ÄúThat‚Äôs not right.‚Äù

She cross-checked the **normal core processes** and remembered: `lsass.exe` must be a child of `wininit.exe`. But here it was ‚Äî **floating freely**. Even worse, it was running from a temp directory, not `C:\Windows\System32`.

This was not the real `lsass.exe`.

To dig deeper, she ran **Process Explorer**. She saw the rogue `lsass.exe` had unusual DLLs injected and was opening files in a user profile folder ‚Äî suspicious behavior for a system process.

To confirm her suspicion, Mira launched **TCPView**. The fake `lsass.exe` was reaching out to an unknown IP over port 443.

Boom. üî• A fake system process beaconing out. Mira pulled the plug and started containment.

From just understanding core Windows processes and using **Sysinternals tools**, she stopped what could‚Äôve been a full-blown credential harvesting campaign.

---

## üìù Endpoint Visibility Tools in Windows

### üìÅ Windows Event Logs

- **Purpose**: Audit significant system activities (e.g., logins, failures, process starts).
- **Stored in**: `.evt` / `.evtx` binary format in `C:\Windows\System32\winevt\Logs`
- **Access Methods**:
    - **Event Viewer** (GUI)
    - `wevtutil.exe` (CLI)
    - `Get-WinEvent` (PowerShell)
      
üß† Logs provide valuable context during incident response but require parsing/analysis tools to be most useful.


### üîç Sysmon (System Monitor)

- Part of the **Sysinternals Suite**
- Collects **high-fidelity**, **detailed endpoint telemetry**
- Can log **process creation**, **network connections**, **registry changes**, **file creation**, etc.
- Works well with SIEMs (e.g., Splunk, ELK)
- Logs show up in Event Viewer under the **Microsoft-Windows-Sysmon/Operational** channel
- Uses **configuration files** to define what events to monitor
- Known config: [SwiftOnSecurity/sysmon-config](https://github.com/SwiftOnSecurity/sysmon-config)
    

üí° **Event ID categories** (some examples):

- 1: Process Creation
- 3: Network Connection
- 11: File Creation
- 13: Registry Object Access
    

### üíª OSQuery

- Developed by **Facebook**.
- Allows querying system data using **SQL-like syntax**
- Supported on **Windows, Linux, macOS, FreeBSD**
- CLI: `osqueryi`
    

üß† Example Query:

```sql
SELECT pid, name, path FROM processes WHERE name='lsass.exe';
```

- Use case: Endpoint queries without heavy tooling
- Use with **Kolide Fleet** to query multiple systems centrally
    

### üìä Wazuh (Open-source EDR)

- Centralized EDR tool built on the **manager-agent model**
- Manager aggregates telemetry from all agent machines
- Features:
    - Vulnerability detection
    - Real-time monitoring (logins, brute-force, privilege escalation)
    - Anomaly detection
    - Dashboard-based event correlation and visualization
        

#### üß† Use Wazuh for:

- Endpoint baseline monitoring
- Security orchestration and response
- SIEM integration
    

### üìñ Story: The Hunt Begins

Jaya, a junior security analyst at a mid-sized enterprise, just got a ping. A developer had reported slow performance and weird popups ‚Äî classic signs of a compromise.

Instead of just guessing, Jaya began her investigation with the **Event Viewer**, diving into Windows Event Logs. She knew that most system logs lived in `.evtx` files and found strange **login attempts** and **failed logon events** from an unusual IP.

"Could be brute-force," she muttered.

She shifted her attention to **Sysmon**, already preconfigured with a well-tuned config from SwiftOnSecurity. Sysmon logs gave her detailed telemetry: a process named `update.exe` had spawned suspicious child processes and reached out to a sketchy IP.

"Definitely fishy."

Time to validate what was running. She opened `osqueryi` and typed:

```sql
SELECT pid, name, path FROM processes WHERE name='update.exe';
```

Sure enough, `update.exe` wasn‚Äôt part of any legit software suite, and it was running from `%AppData%`. Textbook persistence.

To scale her response, she logged into the **Kolide Fleet** dashboard and ran the same OSQuery query across all company systems. Three more endpoints had the same suspicious process.

That‚Äôs when she opened **Wazuh**. From the centralized console, she noticed:

- Privilege escalation attempts
- Unusual registry changes
- Spike in outbound DNS traffic
    

Within minutes, Wazuh gave her visual graphs, alerting her to the scope. She tagged the systems, escalated to incident response, and began containment ‚Äî all using endpoint visibility tools.

She wasn‚Äôt just observing a system anymore.
She was _hunting_.

---

## üìù Event Correlation, Baselining & Investigation Activity

### üìå Event Correlation

**Definition**:  
Event correlation is the process of identifying and mapping **related artefacts** from different log sources (e.g., endpoint, network, firewall, and application logs) to **understand an incident** holistically.

**Purpose**:  
To tie together artefacts (events) from various data sources and **reconstruct the attack path** or behaviour.

**Common Sources**:

- Sysmon Logs (e.g., Event ID 3: Network Connection)
- Firewall Logs
- IDS/IPS Alerts
- Windows Event Logs
- Application Logs
    

**Example Artefact Map**:

|Log Data Source|Artefact|
|---|---|
|Sysmon|Process name, User account, Machine name|
|Firewall Log|Src IP, Dst IP, Ports, Protocol, Action Taken|
|Combined Result|End-to-end trace of connection attempt with user context|

**Why it's important**:  
Helps build **attack timelines**, identify **root cause**, and define **scope of compromise**.


### üìå Baselining

**Definition**:  
Baselining refers to understanding **what‚Äôs normal** in your environment to identify **anomalies** or outliers that might be malicious.

**Activities monitored for baseline**:

- User login times and patterns
- Network traffic volume and destinations
- Commonly used applications
- Typical process names and behaviours
    

**Baseline vs. Unusual Activities Table**:

|Baseline|Unusual Activity|
|---|---|
|London users working 9AM‚Äì6PM|VPN login from Singapore at 3AM|
|One workstation per user|User authenticating on multiple machines|
|Access to only approved sites (e.g., OneDrive)|3GB upload to Google Drive|
|Only MS apps allowed|`firefox.exe` observed on many workstations|

üß† Knowing what‚Äôs "normal" helps **immediately spot** potential threats.


### üß™ Investigation Activity

#### **What You Need**:

- Sysmon/Event Logs from the affected endpoint
- Baseline knowledge of normal user/system behaviour
- Tools for event correlation (SIEM, EDR, Log aggregator)
    
#### **Goal**:

- Trace the root cause of an alert
- Determine whether it is benign or malicious
- Build a timeline of related activities
    

#### üõ† Use cases:

- Suspicious network connection? ‚Üí Check process + user via Sysmon
- Unusual login time? ‚Üí Cross-check user baseline
- Unknown process running? ‚Üí Compare with allowed applications list
    

### üìñ Story: The Curious Case of the 3AM Upload

It was just past 10 AM when Ravi, the on-call blue team analyst, sipped his coffee and glanced over the SOC dashboard. A high-severity alert pinged: **VPN login from Singapore at 03:12 AM**.

"Odd," Ravi whispered, toggling to the user‚Äôs profile. The account belonged to Natalie, a finance associate known to work from the London office‚Äîduring standard hours.

Ravi opened Wazuh and checked correlated logs.

**Firewall Logs** showed:

- VPN login from IP `113.98.21.44` at 03:12
    
- Large upload to `drive.google.com` shortly after
    

**Sysmon Logs** revealed:

- Process `powershell.exe` launched by `svchost.exe` at 03:15
    
- Followed by a 3GB file transfer via `chrome.exe`
    

He paused. Chrome was legit‚Äîbut that behaviour wasn‚Äôt. Natalie usually accessed only OneDrive and SharePoint.

He pulled up the **baseline records**:  
‚úÖ Normal login hours: 8:30‚Äì17:30  
‚úÖ Normal upload size: <200MB  
‚úÖ Approved apps: Word, Excel, Teams, Chrome

But here:  
‚ùå VPN from Asia at 3AM  
‚ùå 3GB outbound file  
‚ùå Powershell spawned indirectly

This was no ordinary activity.

Ravi expanded the **event correlation** across Sysmon + firewall + authentication logs. It showed:

- The user session was hijacked.
    
- A malicious scheduled task ran at login.
    
- A previously unseen process ‚Äî `updatehost.exe` ‚Äî opened Chrome for data exfil.
    

He wrote a quick incident report and isolated Natalie‚Äôs device.

Thanks to **event correlation** and **baselining**, Ravi didn‚Äôt just detect a breach. He _understood_ it.