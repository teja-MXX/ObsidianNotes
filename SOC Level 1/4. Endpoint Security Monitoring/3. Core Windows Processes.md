## 🧠 Understanding Task Manager and Process Analysis

### 🖥️ What is Task Manager?

**Task Manager** is a built-in **GUI-based utility** in Windows used to:

- View all currently running applications and processes.
- Monitor **CPU** and **memory usage**.
- **End (kill)** unresponsive programs.
- Get insights into system **resource usage**.


### 📁 Categories of Processes

Within the **Processes** tab, processes are grouped into:

- **Apps**
- **Background processes**
- **Windows processes**


### ⚠️ Spotting Anomalies

If a process like `svchost.exe`:

- Has an **unexpected image path**
- Has an **unusual command line**
- Or doesn't have **services.exe** as the parent process

...then it's worth investigating further.

#### Problem: Task Manager Limitation
- Task Manager **does NOT** show **Parent-Child process relationships**.

### 🛠️ Better Alternatives
- To investigate relationships between processes, use:
#### ✅ Process Hacker

- Free and open-source
- Shows parent-child tree view
- Powerful analysis features

#### ✅ Process Explorer (by Sysinternals)

- Visual breakdown of:
  - Handles
  - DLLs
  - Network usage
  - Services
  - Parent/child hierarchies


### 📟 Command-Line Alternatives

Familiarize yourself with CLI-based process monitoring:

#### CMD / PowerShell:

```bash
tasklist
```

```powershell
Get-Process
```

```cmd
wmic process list brief
```

### 🧠 Key Takeaway

Task Manager is a **powerful built-in utility**, but:

- It lacks certain columns like **Parent Process**
- For real investigations, prefer **Process Explorer** or **Process Hacker**
- Learn CLI alternatives (`tasklist`, `Get-Process`, `wmic`) for environments without GUI access

---

## 🧠 Windows Core Process: System (PID 4)

### 🔍 What is the System Process?

The `System` process is **always assigned PID 4**. It’s the **first and one of the most essential processes** in a Windows operating system.

> 📘 From *Windows Internals 6th Edition*:
> 
> “The System process (process ID 4) is the home for a special kind of thread that runs only in **kernel mode** — a kernel-mode system thread. These threads run in system space (like in `ntoskrnl.exe` or other device drivers). They do not have a user-mode address space and use OS memory heaps such as paged or nonpaged pool.”


Now let's discuss Kernal Mode vs User Mode
### 🧱 What is Kernel-Mode vs. User-Mode?

> Not covered here directly, but for clarity: 
- **Kernel-mode**: Code has unrestricted access to system memory and hardware. #kernelmode 
- **User-mode**: Limited access for safety, used by applications. #usermode 
- Covered more here in here -  [[User Mode vs Kernel Mode]]

### ✅ Normal Behavior of `System` Process

You can observe the process using **Process Explorer** or **Process Hacker**.

### Process Explorer View:

| Property         | Value                              |
|------------------|-------------------------------------|
| Image Path       | N/A                                 |
| Parent Process   | None                                |
| Number of Instances | 1                              |
| User Account     | `Local System`                     |
| Start Time       | Boot time                           |

#### Process Hacker View:

| Property         | Value                                   |
|------------------|------------------------------------------|
| Image Path       | `C:\Windows\System32\ntoskrnl.exe`        |
| Parent Process   | `System Idle Process (PID 0)`             |
| Verified Publisher | Microsoft Windows (Verified)           |

### ❌ Unusual Behavior of `System` Process

These are **red flags** when analyzing this process:

- 🛑 **Parent process other than System Idle Process (PID 0)**
- 🛑 **Multiple instances** of the System process (only one should exist)
- 🛑 **Different PID** (should *always* be PID 4)
- 🛑 **Running outside of Session 0**


### 🧠 Summary

The `System` process (PID 4) is:
- The **home of kernel-mode threads**.
- A **critical, non-user-facing process**.
- A process that should always:
  - Have PID 4
  - Run at boot time
  - Be verified as a Microsoft system component
  - Be launched with no parent process (or from PID 0)

Use **Process Hacker** or **Process Explorer** to verify its authenticity when hunting for anomalies.

---

## ⚙️ Core Windows Process: `smss.exe` (Session Manager Subsystem)

### 📄 What is `smss.exe`?

`smss.exe` stands for **Session Manager Subsystem**. It is the **first user-mode process** started by the Windows kernel. It is responsible for creating **new sessions** and initializing critical components of the Windows subsystem. #smss 

### 🔧 What Does `smss.exe` Do?

- Starts **kernel and user-mode components** of the Windows subsystem:
  - Kernel-mode: `win32k.sys`
  - User-mode: `winsrv.dll` and `csrss.exe`
- Starts:
  - `csrss.exe` and `wininit.exe` in **Session 0** (OS session)
  - `csrss.exe` and `winlogon.exe` in **Session 1** (user session)
- Copies itself into each new session and **self-terminates** after setting it up.
- Creates:
  - Environment variables
  - Virtual memory paging files
  - Starts `winlogon.exe` (Windows Logon Manager)
- Launches additional subsystems listed in:
	- `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Subsystems`

Explained here with an analogy - [[SMSS - Session Manager Subsystem]]

### ✅ Normal Behavior

| Attribute         | Expected Value                             |
|------------------|---------------------------------------------|
| **Image Path**    | `%SystemRoot%\System32\smss.exe`           |
| **Parent Process**| `System` (PID 4)                           |
| **Instances**     | One **master instance**, and a **child per session** (children terminate after launching) |
| **User Account**  | `Local System`                             |
| **Start Time**    | Within seconds of **boot time**            |
![[Pasted image 20250615132213.png]]
### 🧪 Session Visual Examples

#### 🪟 Session 0
- Starts:
- `csrss.exe`
- `wininit.exe`
![[Pasted image 20250615132007.png]]
![[Pasted image 20250615132110.png]]
#### 👤 Session 1
- Starts:
- `csrss.exe`
- `winlogon.exe`
![[Pasted image 20250615132017.png]]
![[Pasted image 20250615132121.png]]

### ❌ Unusual Behavior (Anomalies)

These are **red flags** when analyzing `smss.exe`:

- 🔴 **Parent process is not `System` (PID 4)**
- 🔴 **Image path is NOT `C:\Windows\System32`**
- 🔴 **Multiple instances running** (Child copies should **self-terminate**)
- 🔴 **User is not SYSTEM**
- 🔴 **Suspicious or unknown registry entries** under `Session Manager\Subsystems`


### 🔍 Registry Key to Monitor

```plaintext
HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Subsystems
```

Ensure that the values under this registry path are expected and unchanged. Malicious processes may tamper with these to inject unauthorized subsystems.

### 🧠 Summary
- smss.exe is critical for Windows session creation.
- It launches early and hands off startup to key components.
- Should have only one persistent instance.
- Any extra instances or deviation in path/parent/user warrants investigation.

---

## ⚙️ Core Windows Process: `csrss.exe` (Client Server Runtime Process)

### 📄 What is `csrss.exe`?

`csrss.exe` stands for **Client Server Runtime Process**, which is a **critical user-mode component** of the Windows subsystem. It is always running and is essential to system stability. Terminating this process will lead to **system failure**.

### 🔧 Responsibilities

- Handles:
  - Win32 **console window**
  - **Thread creation** and **deletion**
- Loads critical DLLs:
  - `csrsrv.dll`
  - `basesrv.dll`
  - `winsrv.dll`
- Manages:
  - Windows **API accessibility** to other processes
  - **Drive letter mapping**
  - **System shutdown**


### 🧪 Relationship with `smss.exe`

- `csrss.exe` is **spawned by `smss.exe`** at system boot.
- Created during:
  - **Session 0**: OS session
  - **Session 1**: User session
- `smss.exe` **self-terminates** after launching these processes.


### ✅ Normal Behavior

| Attribute         | Expected Value                                          |
|------------------|----------------------------------------------------------|
| **Image Path**    | `%SystemRoot%\System32\csrss.exe` (e.g., `C:\Windows\System32`) |
| **Parent Process**| An instance of `smss.exe` (which self-terminates)       |
| **Instances**     | 2+ — typically **Session 0** and **Session 1**          |
| **User Account**  | `Local System`                                          |
| **Start Time**    | Within **seconds of boot time** for initial instances   |

### 🧪 Visual Example

#### 🪟 Session 0
- Typical PID (e.g., 392)
- System-level background processes
![[Pasted image 20250615134930.png]]
#### 👤 Session 1
- Typical PID (e.g., 512)
- User-level GUI and session management
![[Pasted image 20250615134939.png]]
### ❌ Unusual Behavior (Anomalies)

These are red flags when analyzing `csrss.exe`:

- 🔴 **Visible parent process** still active (should be `smss.exe` which self-terminates)
- 🔴 **Image path not in** `C:\Windows\System32`
- 🔴 **Spelling deviations** like `csrrss.exe` or `csrus.exe`
- 🔴 **User account is NOT** `SYSTEM`
- 🔴 **More than two running instances** without corresponding session justification

### 🧠 Summary

- `csrss.exe` is essential for Windows operation and stability.
- Only expect **two or so instances**, tied to system and user sessions.
- Monitor its **path, parent, user, and spelling** to detect impersonation or rogue processes.

---

## ⚙️ Core Windows Process: `wininit.exe` (Windows Initialization Process)

### 📄 What is `wininit.exe`?

`wininit.exe` is the **Windows Initialization Process** that runs in **Session 0** and is responsible for **starting other critical system processes** after the kernel has initialized the system. #wininit 

![[Pasted image 20250615153301.png]]
### 🔧 Responsibilities

- Launches the following child processes:
  - `services.exe` – Service Control Manager (SCM)
  - `lsass.exe` – Local Security Authority Subsystem
  - `lsaiso.exe` – Associated with **Credential Guard and KeyGuard**
    - Only visible if **Credential Guard** is **enabled**

More about it in - [[WININIT - Windows Initialization]]
### ✅ Normal Behavior

| Attribute          | Expected Value                                         |
|-------------------|--------------------------------------------------------|
| **Image Path**     | `%SystemRoot%\System32\wininit.exe` (e.g., `C:\Windows\System32`) |
| **Parent Process** | An instance of `smss.exe` (which **self-terminates**) |
| **Number of Instances** | One                                              |
| **User Account**   | `Local System`                                        |
| **Start Time**     | Within **seconds of boot time**                       |
![[Pasted image 20250615153313.png]]

### 🌲 Process Tree Example
System (PID 4)  
└─ smss.exe  
└─ wininit.exe  
└─ services.exe  
└─lsass.exe  
└─ lsaiso.exe (if Credential Guard is enabled)


### ❌ Unusual Behavior (Anomalies)

Red flags when analyzing `wininit.exe`:

- 🔴 **Visible or active parent process** (should be from `smss.exe`, which terminates)
- 🔴 **Image path not in** `C:\Windows\System32`
- 🔴 **Spelling anomalies** like `winit.exe` or `winlnit.exe`
- 🔴 **Multiple running instances**
- 🔴 **User is NOT** `SYSTEM`


### 🧠 Summary

- `wininit.exe` is a **critical bootstrap process** for launching background Windows services.
- It should only appear once and must originate from the **System32** directory.
- It should **never have a persistent parent process** and must run as **Local System**.

---




