## 🧠 Understanding Task Manager and Process Analysis

### 🖥️ What is Task Manager?

**Task Manager** is a built-in **GUI-based utility** in Windows used to:

- View all currently running applications and processes.
- Monitor **CPU** and **memory usage**.
- **End (kill)** unresponsive programs.
- Get insights into system **resource usage**.


### 📁 Categories of Processes

Within the **Processes** tab, processes are grouped into:

- **Apps**
- **Background processes**
- **Windows processes**


### ⚠️ Spotting Anomalies

If a process like `svchost.exe`:

- Has an **unexpected image path**
- Has an **unusual command line**
- Or doesn't have **services.exe** as the parent process

...then it's worth investigating further.

#### Problem: Task Manager Limitation
- Task Manager **does NOT** show **Parent-Child process relationships**.

### 🛠️ Better Alternatives
- To investigate relationships between processes, use:
#### ✅ Process Hacker

- Free and open-source
- Shows parent-child tree view
- Powerful analysis features

#### ✅ Process Explorer (by Sysinternals)

- Visual breakdown of:
  - Handles
  - DLLs
  - Network usage
  - Services
  - Parent/child hierarchies


### 📟 Command-Line Alternatives

Familiarize yourself with CLI-based process monitoring:

#### CMD / PowerShell:

```bash
tasklist
```

```powershell
Get-Process
```

```cmd
wmic process list brief
```

### 🧠 Key Takeaway

Task Manager is a **powerful built-in utility**, but:

- It lacks certain columns like **Parent Process**
- For real investigations, prefer **Process Explorer** or **Process Hacker**
- Learn CLI alternatives (`tasklist`, `Get-Process`, `wmic`) for environments without GUI access

---

## 🧠 Windows Core Process: System (PID 4)

### 🔍 What is the System Process?

The `System` process is **always assigned PID 4**. It’s the **first and one of the most essential processes** in a Windows operating system.

> 📘 From *Windows Internals 6th Edition*:
> 
> “The System process (process ID 4) is the home for a special kind of thread that runs only in **kernel mode** — a kernel-mode system thread. These threads run in system space (like in `ntoskrnl.exe` or other device drivers). They do not have a user-mode address space and use OS memory heaps such as paged or nonpaged pool.”


Now let's discuss Kernal Mode vs User Mode
### 🧱 What is Kernel-Mode vs. User-Mode?

> Not covered here directly, but for clarity: 
- **Kernel-mode**: Code has unrestricted access to system memory and hardware. #kernelmode 
- **User-mode**: Limited access for safety, used by applications. #usermode 
- Covered more here in here -  [[User Mode vs Kernel Mode]]

### ✅ Normal Behavior of `System` Process

You can observe the process using **Process Explorer** or **Process Hacker**.

### Process Explorer View:

| Property         | Value                              |
|------------------|-------------------------------------|
| Image Path       | N/A                                 |
| Parent Process   | None                                |
| Number of Instances | 1                              |
| User Account     | `Local System`                     |
| Start Time       | Boot time                           |

#### Process Hacker View:

| Property         | Value                                   |
|------------------|------------------------------------------|
| Image Path       | `C:\Windows\System32\ntoskrnl.exe`        |
| Parent Process   | `System Idle Process (PID 0)`             |
| Verified Publisher | Microsoft Windows (Verified)           |

### ❌ Unusual Behavior of `System` Process

These are **red flags** when analyzing this process:

- 🛑 **Parent process other than System Idle Process (PID 0)**
- 🛑 **Multiple instances** of the System process (only one should exist)
- 🛑 **Different PID** (should *always* be PID 4)
- 🛑 **Running outside of Session 0**


### 🧠 Summary

The `System` process (PID 4) is:
- The **home of kernel-mode threads**.
- A **critical, non-user-facing process**.
- A process that should always:
  - Have PID 4
  - Run at boot time
  - Be verified as a Microsoft system component
  - Be launched with no parent process (or from PID 0)

Use **Process Hacker** or **Process Explorer** to verify its authenticity when hunting for anomalies.

---

## ⚙️ Core Windows Process: `smss.exe` (Session Manager Subsystem)

### 📄 What is `smss.exe`?

`smss.exe` stands for **Session Manager Subsystem**. It is the **first user-mode process** started by the Windows kernel. It is responsible for creating **new sessions** and initializing critical components of the Windows subsystem. #smss 

### 🔧 What Does `smss.exe` Do?

- Starts **kernel and user-mode components** of the Windows subsystem:
  - Kernel-mode: `win32k.sys`
  - User-mode: `winsrv.dll` and `csrss.exe`
- Starts:
  - `csrss.exe` and `wininit.exe` in **Session 0** (OS session)
  - `csrss.exe` and `winlogon.exe` in **Session 1** (user session)
- Copies itself into each new session and **self-terminates** after setting it up.
- Creates:
  - Environment variables
  - Virtual memory paging files
  - Starts `winlogon.exe` (Windows Logon Manager)
- Launches additional subsystems listed in:
	- `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Subsystems`

Explained here with an analogy - [[SMSS - Session Manager Subsystem]]

### ✅ Normal Behavior

| Attribute         | Expected Value                             |
|------------------|---------------------------------------------|
| **Image Path**    | `%SystemRoot%\System32\smss.exe`           |
| **Parent Process**| `System` (PID 4)                           |
| **Instances**     | One **master instance**, and a **child per session** (children terminate after launching) |
| **User Account**  | `Local System`                             |
| **Start Time**    | Within seconds of **boot time**            |
![[Pasted image 20250615132213.png]]
### 🧪 Session Visual Examples

#### 🪟 Session 0
- Starts:
- `csrss.exe`
- `wininit.exe`
![[Pasted image 20250615132007.png]]
![[Pasted image 20250615132110.png]]
#### 👤 Session 1
- Starts:
- `csrss.exe`
- `winlogon.exe`
![[Pasted image 20250615132017.png]]
![[Pasted image 20250615132121.png]]

### ❌ Unusual Behavior (Anomalies)

These are **red flags** when analyzing `smss.exe`:

- 🔴 **Parent process is not `System` (PID 4)**
- 🔴 **Image path is NOT `C:\Windows\System32`**
- 🔴 **Multiple instances running** (Child copies should **self-terminate**)
- 🔴 **User is not SYSTEM**
- 🔴 **Suspicious or unknown registry entries** under `Session Manager\Subsystems`


### 🔍 Registry Key to Monitor

```plaintext
HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Subsystems
```

Ensure that the values under this registry path are expected and unchanged. Malicious processes may tamper with these to inject unauthorized subsystems.

### 🧠 Summary
- smss.exe is critical for Windows session creation.
- It launches early and hands off startup to key components.
- Should have only one persistent instance.
- Any extra instances or deviation in path/parent/user warrants investigation.

---

## ⚙️ Core Windows Process: `csrss.exe` (Client Server Runtime Process)

### 📄 What is `csrss.exe`?

`csrss.exe` stands for **Client Server Runtime Process**, which is a **critical user-mode component** of the Windows subsystem. It is always running and is essential to system stability. Terminating this process will lead to **system failure**.

### 🔧 Responsibilities

- Handles:
  - Win32 **console window**
  - **Thread creation** and **deletion**
- Loads critical DLLs:
  - `csrsrv.dll`
  - `basesrv.dll`
  - `winsrv.dll`
- Manages:
  - Windows **API accessibility** to other processes
  - **Drive letter mapping**
  - **System shutdown**


### 🧪 Relationship with `smss.exe`

- `csrss.exe` is **spawned by `smss.exe`** at system boot.
- Created during:
  - **Session 0**: OS session
  - **Session 1**: User session
- `smss.exe` **self-terminates** after launching these processes.


### ✅ Normal Behavior

| Attribute         | Expected Value                                          |
|------------------|----------------------------------------------------------|
| **Image Path**    | `%SystemRoot%\System32\csrss.exe` (e.g., `C:\Windows\System32`) |
| **Parent Process**| An instance of `smss.exe` (which self-terminates)       |
| **Instances**     | 2+ — typically **Session 0** and **Session 1**          |
| **User Account**  | `Local System`                                          |
| **Start Time**    | Within **seconds of boot time** for initial instances   |

### 🧪 Visual Example

#### 🪟 Session 0
- Typical PID (e.g., 392)
- System-level background processes
![[Pasted image 20250615134930.png]]
#### 👤 Session 1
- Typical PID (e.g., 512)
- User-level GUI and session management
![[Pasted image 20250615134939.png]]
### ❌ Unusual Behavior (Anomalies)

These are red flags when analyzing `csrss.exe`:

- 🔴 **Visible parent process** still active (should be `smss.exe` which self-terminates)
- 🔴 **Image path not in** `C:\Windows\System32`
- 🔴 **Spelling deviations** like `csrrss.exe` or `csrus.exe`
- 🔴 **User account is NOT** `SYSTEM`
- 🔴 **More than two running instances** without corresponding session justification

### 🧠 Summary

- `csrss.exe` is essential for Windows operation and stability.
- Only expect **two or so instances**, tied to system and user sessions.
- Monitor its **path, parent, user, and spelling** to detect impersonation or rogue processes.

---

## ⚙️ Core Windows Process: `wininit.exe` (Windows Initialization Process)

### 📄 What is `wininit.exe`?

`wininit.exe` is the **Windows Initialization Process** that runs in **Session 0** and is responsible for **starting other critical system processes** after the kernel has initialized the system. #wininit 

![[Pasted image 20250615153301.png]]
### 🔧 Responsibilities

- Launches the following child processes:
  - `services.exe` – Service Control Manager (SCM)
  - `lsass.exe` – Local Security Authority Subsystem
  - `lsaiso.exe` – Associated with **Credential Guard and KeyGuard**
    - Only visible if **Credential Guard** is **enabled**

More about it in - [[WININIT - Windows Initialization]]
### ✅ Normal Behavior

| Attribute          | Expected Value                                         |
|-------------------|--------------------------------------------------------|
| **Image Path**     | `%SystemRoot%\System32\wininit.exe` (e.g., `C:\Windows\System32`) |
| **Parent Process** | An instance of `smss.exe` (which **self-terminates**) |
| **Number of Instances** | One                                              |
| **User Account**   | `Local System`                                        |
| **Start Time**     | Within **seconds of boot time**                       |
![[Pasted image 20250615153313.png]]

### 🌲 Process Tree Example
System (PID 4)  
└─ smss.exe  
└─ wininit.exe  
└─ services.exe  
└─lsass.exe  
└─ lsaiso.exe (if Credential Guard is enabled)


### ❌ Unusual Behavior (Anomalies)

Red flags when analyzing `wininit.exe`:

- 🔴 **Visible or active parent process** (should be from `smss.exe`, which terminates)
- 🔴 **Image path not in** `C:\Windows\System32`
- 🔴 **Spelling anomalies** like `winit.exe` or `winlnit.exe`
- 🔴 **Multiple running instances**
- 🔴 **User is NOT** `SYSTEM`


### 🧠 Summary

- `wininit.exe` is a **critical bootstrap process** for launching background Windows services.
- It should only appear once and must originate from the **System32** directory.
- It should **never have a persistent parent process** and must run as **Local System**.

---

## ⚙️ Core Windows Process: `services.exe` (Service Control Manager - SCM)

### 📄 What is `services.exe`?

`services.exe` is the **Service Control Manager (SCM)**. It is responsible for **managing system services** in Windows – loading, starting, stopping, and interacting with them. It also starts key background processes during boot and is **critical** to proper system operation. #scm 

More about it in here - [[SCM - Service Control Manager]]

```powershell
C:\Users\Administrator> sc.exe 
DESCRIPTION: 
	SC is a command line program used for communicating with the 
	Service Control Manager and services. 

USAGE: 
	sc <server> [command] [service name] <option1> <option2>...
```

Information regarding services is stored in the registry `HKLM\System\CurrentControlSet\Services`.

![[Pasted image 20250617120801.png]]
### 🔧 Responsibilities

- Loads and manages **auto-start services and drivers**
- Interfaces with Windows services using the **SCM database**
  - Can be queried with: `sc.exe`
- Updates the **LastKnownGoodConfiguration** registry key:
  - `HKLM\System\Select\LastKnownGood` ← set to `CurrentControlSet` upon successful login
    
    ![[Pasted image 20250617120919.png]]
    
- **Loads drivers** marked for auto-start
- Acts as **parent process** for multiple critical services:
  - `svchost.exe`
  - `spoolsv.exe`
  - `msmpeng.exe`
  - `dllhost.exe`
    
    ![[Pasted image 20250617121055.png]]



### ✅ Normal Behavior

| Attribute               | Expected Value                       |
| ----------------------- | ------------------------------------ |
| **Image Path**          | `%SystemRoot%\System32\services.exe` |
| **Parent Process**      | `wininit.exe`                        |
| **Number of Instances** | One                                  |
| **User Account**        | `Local System`                       |
| **Start Time**          | Within **seconds of system boot**    |
![[Pasted image 20250617121116.png]]
![[Pasted image 20250617121134.png]]
### 📂 Registry

| Registry Location                        | Purpose                                |
| ---------------------------------------- | -------------------------------------- |
| `HKLM\System\CurrentControlSet\Services` | Services configuration storage         |
| `HKLM\System\Select\LastKnownGood`       | Last known good configuration tracking |

### 🌲 Process Tree Example
System (PID 4)  
└─ smss.exe  
└─ wininit.exe  
└─ services.exe  
└─  svchost.exe  
└─  spoolsv.exe  
└─  dllhost.exe  
└─ msmpeng.exe

### ❌ Unusual Behavior (Anomalies)

Red flags for `services.exe`:

- 🔴 **Parent process** is NOT `wininit.exe`
- 🔴 **Image path** not in `C:\Windows\System32`
- 🔴 **Misspelled variants** (e.g., `serv1ces.exe`, `servlces.exe`)
- 🔴 **Multiple running instances**
- 🔴 Not running under **SYSTEM** user account

### 🧠 Summary

- `services.exe` is a **centralized process manager** for Windows services.
- It should start from `wininit.exe` and run **only once** as **Local System**.
- Knowing this baseline is crucial to **spotting rogue processes** masquerading as `services.exe`.

---
## 🧩 Core Windows Process: `svchost.exe` (Service Host)

### 📄 What is `svchost.exe`?

`svchost.exe` is the **Service Host** responsible for **hosting and managing Windows services**. It enables Windows to run multiple services from shared process instances to optimize resource consumption. #svchost 

- Each `svchost.exe` hosts **one or more services implemented as DLLs**
- Services are grouped using the **`-k` parameter**
- Commonly found **multiple times** in any Windows system
- Has been abused by **malware to masquerade** as a legitimate service host

![[Pasted image 20250617122027.png]]

More about it here - [[SVCHost - Service Host]]
### 🧠 How Services Are Implemented

- The **DLL path** for a service is stored in the registry: `HKLM\SYSTEM\CurrentControlSet\Services<SERVICE NAME>\Parameters\ServiceDLL`
- The `-k` parameter in the command line indicates **service grouping**.
	- Example: `svchost.exe -k DcomLaunch`
- From **Windows 10 v1703+**, machines with **more than 3.5 GB RAM** use **separate processes** per service to improve reliability.

![[Pasted image 20250617122112.png]]
### 🧰 How to Inspect in Process Hacker

1. Locate `svchost.exe` (e.g., PID 748)
2. Right-click → Properties
3. View **Command Line** for `-k` grouping identifier
4. View **ServiceDLL** for actual DLL path
5. For example,  For service `LSM`:
	- `-k` value: `DcomLaunch`
	- Registry path for DLL: `HKLM\SYSTEM\CurrentControlSet\Services\LSM\Parameters\ServiceDLL`

![[Pasted image 20250617122120.png]]
![[Pasted image 20250617122130.png]]
![[Pasted image 20250617122154.png]]
![[Pasted image 20250617122200.png]]
![[Pasted image 20250617122206.png]]
### ✅ Normal Behavior

| Attribute             | Expected Value                                                  |
|----------------------|------------------------------------------------------------------|
| **Image Path**       | `%SystemRoot%\System32\svchost.exe`                              |
| **Parent Process**   | `services.exe`                                                   |
| **Number of Instances** | Many                                                          |
| **User Account**     | `SYSTEM`, `Network Service`, `Local Service`, or logged-in user  |
| **Start Time**       | Seconds after boot (some instances may launch later)             |
![[Pasted image 20250617122218.png]]
### 🚨 What Is Unusual?

| Red Flags                                              |
|--------------------------------------------------------|
| Parent process is **not** `services.exe`               |
| Image file is **not in** `C:\Windows\System32`         |
| Process is **misspelled** (e.g., `scvhost.exe`)        |
| Missing **`-k` parameter** in command line             |

### 🔎 Why `svchost.exe` Matters

Due to its **ubiquity and multiple instances**, attackers often exploit this process to:
- Masquerade malware as a system service
- Inject malicious DLLs into real service groups
- Evade detection by mimicking legitimate behavior

Always inspect the **image path**, **service grouping (`-k`)**, and **parent process** to validate legitimacy.

---

## 🛡️ Core Windows Process: `lsass.exe` (Local Security Authority Subsystem Service)

### 📄 What is `lsass.exe`?

The **Local Security Authority Subsystem Service (LSASS)** is a critical Windows process that enforces **security policies** on the system. It plays a pivotal role in **authentication, authorization, and auditing**. #lsass 

More about it here - [[LSASS - Local Security Authority Subsystem Service]]
#### 🔐 Responsibilities:
- Verifies users during **logon** to Windows
- Handles **password changes**
- Creates **access/security tokens**
- Interfaces with:
  - **SAM** (Security Account Manager)
  - **AD** (Active Directory)
  - **NETLOGON**
- Logs security-related events to the **Windows Security Log**

### 🧠 How LSASS Works

- Uses **authentication packages** defined in the registry: `HKLM\System\CurrentControlSet\Control\Lsa`
- Example: Registry snapshot from `Lsa` key shows packages used for security functions

![[Pasted image 20250617123346.png]]
### 🧰 Why LSASS is a Target

Attackers attempt to:
- **Dump credentials** from LSASS memory using tools like `mimikatz`
- Create **malware** named `lsass.exe` to **blend in**
- Use **slight misspellings** like `lsaas.exe` or `Isass.exe` to go unnoticed

🔗 [Extra reading on LSASS abuse and Microsoft’s mitigations](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/audit-credential-validation)

### ✅ Normal Behavior

| Attribute               | Expected Value                    |
| ----------------------- | --------------------------------- |
| **Image Path**          | `%SystemRoot%\System32\lsass.exe` |
| **Parent Process**      | `wininit.exe`                     |
| **Number of Instances** | One                               |
| **User Account**        | `Local System`                    |
| **Start Time**          | Within seconds of boot time       |

![[Pasted image 20250617123354.png]]
### 🚨 What Is Unusual?

| Red Flags                                              |
|--------------------------------------------------------|
| Parent process is **not** `wininit.exe`                |
| Image file path **differs from** `C:\Windows\System32` |
| Misspelled name (e.g., `Isass.exe`, `lsaas.exe`)       |
| Multiple running instances                             |
| Not running under `SYSTEM` account                     |

### 🔍 Why LSASS Matters in Investigations

Due to its direct interaction with:
- **Login credentials**
- **Password changes**
- **Security tokens**

...compromising or imitating `lsass.exe` gives adversaries **high privilege access** and potentially **complete system control**.

**Always verify:**
- The **image path**
- The **parent process**
- The **number of instances**
- The **account it's running under**

---

## 🪪 Core Windows Process: `winlogon.exe` (Windows Logon Application)

### 📄 What is `winlogon.exe`?

`winlogon.exe` is a **critical system process** that manages secure logon operations for Windows. It handles the **Secure Attention Sequence (SAS)** triggered by pressing **Ctrl+Alt+Del**, ensuring secure interaction between user and system. #winlogon 

More about it here - [[WINLOGON - Windows Logon]]

![[Pasted image 20250617125144.png]]
### 🔐 Responsibilities

- Handles **Secure Attention Sequence (SAS)** (Ctrl+Alt+Del)
- Loads the **user profile** (e.g., `NTUSER.DAT` into `HKCU`)
- Starts `userinit.exe` to load the user’s **shell**
- Manages:
  - **Screen locking**
  - **Screensaver launching**
  - **Logon and logoff events**

🧠 Related Registry Key: `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`

![[Pasted image 20250617125154.png]]

### 🧬 Process Tree Behavior

- Spawned by `smss.exe` for **Session 1**
- Pairs with `csrss.exe` during session creation
- Session 1 typically reflects **interactive user logon**
- Additional instances occur during **Remote Desktop sessions** or **Fast User Switching**

🖼️ Example:  
`smss.exe` → `winlogon.exe` (Session 1)

### ✅ Normal Behavior

| Attribute               | Expected Value                               |
| ----------------------- | -------------------------------------------- |
| **Image Path**          | `%SystemRoot%\System32\winlogon.exe`         |
| **Parent Process**      | `smss.exe` (self-terminates, so not visible) |
| **Number of Instances** | One or more (Session-based)                  |
| **User Account**        | `Local System`                               |
| **Start Time**          | Within seconds of boot time (Session 1)      |
![[Pasted image 20250617125208.png]]

![[Pasted image 20250617125216.png]]
### 🚨 What Is Unusual?

| Red Flags                                                                     |
| ----------------------------------------------------------------------------- |
| Parent process is visible (smss.exe **self-terminates**, so this is abnormal) |
| Image file path **not** in `C:\Windows\System32`                              |
| Slight **misspellings** (e.g., `winlogn.exe`) to **masquerade malware**       |
| Not running under `SYSTEM` account                                            |
| Registry `Shell` value is **not** `explorer.exe`                              |

📌 *Note*: Malicious actors may replace the default shell with their own executable for persistence.

### 🔍 Why `winlogon.exe` Matters

It is central to the **interactive logon process**, and manipulating it can:
- Bypass authentication
- Replace the user’s desktop environment
- Allow stealthy persistence or control

💡 Always verify:
- The **file path**
- That it's running as **SYSTEM**
- **Registry shell value** = `explorer.exe`

---

## 🗂️ Core Windows Process: `explorer.exe` (Windows Explorer)

### 📄 What is `explorer.exe`?

`explorer.exe` is the Windows graphical shell. It provides the **desktop environment**, including:
- File Explorer interface
- Start Menu
- Taskbar
- System Tray
- Quick access to drives, folders, and files

### 🧬 Process Tree Behavior

- Spawned by `userinit.exe` (itself called by `winlogon.exe`)
- `userinit.exe` exits immediately after spawning `explorer.exe`
- No visible parent process in most tools

🖼️ Typical process chain:
`winlogon.exe` → `userinit.exe` → `explorer.exe`

`explorer.exe` is the **parent** of many user-launched applications.

![[Pasted image 20250617125432.png]]

### ✅ Normal Behavior

| Attribute               | Expected Value                               |
| ----------------------- | -------------------------------------------- |
| **Image Path**          | `%SystemRoot%\explorer.exe`                  |
| **Parent Process**      | Launched by `userinit.exe` which exits       |
| **Number of Instances** | One or more per interactively logged-in user |
| **User Account**        | Current logged-in user                       |
| **Start Time**          | On first interactive logon                   |

![[Pasted image 20250617125444.png]]

### 🚨 What Is Unusual?

| Red Flags                                                                  |
| -------------------------------------------------------------------------- |
| Actual visible parent process (shouldn’t exist since `userinit.exe` exits) |
| Image file path **not in** `C:\Windows`                                    |
| Running as an **unknown or SYSTEM user** (should be user account)          |
| **Misspelled names** like `expl0rer.exe` to hide malicious intent          |
| Making **outbound TCP/IP connections** (suspicious for a GUI shell)        |

### 🛡️ Why It Matters

Since `explorer.exe` is a **user-facing process** and often **spawns other apps**, attackers may:
- Masquerade malware as `explorer.exe`
- Hook into it to **evade detection**
- Use it to **persist** or **launch C2 traffic**

💡 Always validate:
- **Correct file path** in `%SystemRoot%`
- Running under the **correct user**
- **No unexplained network activity**







