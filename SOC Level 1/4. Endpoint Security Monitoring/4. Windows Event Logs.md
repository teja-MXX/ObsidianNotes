## 📄 Windows Event Logs Overview

### 📂 Storage Format
- Windows Event Logs are stored in **binary format** (.evt / .evtx).
- Cannot be viewed with a text editor.
- **Location**: `C:\Windows\System32\winevt\Logs`
- Data is **translated to XML** via the Windows API.

### 🧩 Elements of a Windows Event Log

#### 🔸 Log Categories

| Category                            | Description                                                  |
| ----------------------------------- | ------------------------------------------------------------ |
| **System Logs**                     | OS-level events (hardware, drivers, system changes).         |
| **Security Logs**                   | Logon/logoff attempts, defined by audit policy.              |
| **Application Logs**                | App-generated events (errors, warnings, info).               |
| **Directory Service Events**        | Active Directory activity (on DCs).                          |
| **File Replication Service Events** | Group Policy & logon script replication.                     |
| **DNS Event Logs**                  | Domain query/response events.                                |
| **Custom Logs**                     | Application-specific logs, often with ACLs or custom sizing. |

### 🧾 Windows Event Log Types

| Type              | Description                                            |
| ----------------- | ------------------------------------------------------ |
| **Information**   | Successful operation of components.                    |
| **Warning**       | Event that is not critical but may indicate a problem. |
| **Error**         | Significant problem, often requiring user attention.   |
| **Success Audit** | Successful security access attempt.                    |
| **Failure Audit** | Failed security access attempt.                        |

### 🔍 Access Methods

| Tool             | Description                                                |
| ---------------- | ---------------------------------------------------------- |
| **Event Viewer** | GUI-based, Microsoft Management Console (MMC) snap-in.     |
| **Wevtutil.exe** | Command-line tool to query and clear logs.                 |
| **Get-WinEvent** | PowerShell cmdlet for querying logs in scriptable formats. |

---

## 🖥️ Event Viewer (eventvwr.msc)

### 🧭 Interface Breakdown

1. **Left Pane**: Hierarchical view of log providers
2. **Middle Pane**: Summary & details of selected provider’s logs
3. **Right Pane**: Actions (filter, clear, save, connect)

### 🔹 Navigation
- Common logs in **Windows Logs**
- Expand: `Applications and Services Logs > Microsoft > Windows > PowerShell > Operational`

### ⚙️ Log Properties (Right-click > Properties)
- **Log Location**
- **Log Size**
- **Created / Modified / Last Accessed**
- **Max Log Size**
- **Log Rotation**: Overwrite oldest events
- **Clear Log**: Adversaries may abuse this to evade detection

### 🪪 Columns in Middle Pane

| Column            | Description                                  |
| ----------------- | -------------------------------------------- |
| **Level**         | Severity of event (e.g., Information, Error) |
| **Date & Time**   | Timestamp of the event                       |
| **Source**        | Application or service generating the log    |
| **Event ID**      | Numeric code linked to an operation          |
| **Task Category** | Defined by event source, used for filtering  |

> Note: **Event IDs are not unique across logs.**

### 🔍 Bottom Section Tabs

- **General**: Human-readable summary
- **Details**: Structured format (Friendly View or XML View)

### 🛠️ Actions Pane Tools

| Tool                               | Use                                                         |
| ---------------------------------- | ----------------------------------------------------------- |
| **Open Saved Log**                 | Useful when reviewing logs from an offline or remote system |
| **Create Custom View**             | Filter logs across sources and types                        |
| **Filter Current Log**             | Filter only the selected log                                |
| **Connect to Another Computer...** | Remote event log viewing                                    |

### 🧠 Example Use Case

You’re only interested in **PowerShell Operational Events** with `Event ID 4104`.  
➡️ Use **Create Custom View** or **Filter Current Log** to isolate this.


### 🎯 Summary

- Event logs are essential for **troubleshooting**, **incident response**, and **forensic investigations**.
- Use **Event Viewer** for efficient navigation and filtering.
- Focus on:
  - **Filtering**
  - **Log rotation policy**
  - **Remote log access**
  - **Understanding normal vs anomalous events**

### 🕵️ Story: Midnight Alert – The PowerShell Anomaly

It was 2:37 AM when Riya, a Tier 1 SOC Analyst at a multinational tech company, received an alert on her SIEM console. The alert was triggered by a **PowerShell execution** flagged as suspicious by the endpoint detection system. The alert read:

> "**PowerShell script execution detected from unknown source – Event ID 4104**"

She started her investigation

#### 🧭 Step 1: Quick Triage

Riya immediately launched the **Windows Event Viewer** on the affected system remotely through their SIEM tool. She navigated to:

**`Applications and 
	Services Logs > 
	Microsoft > 
	Windows > 
	PowerShell > 
	Operational`**

There, she filtered the logs using **Event ID 4104** to see **PowerShell script block logging** events. A familiar yet suspicious base64-encoded script stood out.

> **Riya’s Thought**: _“Let me see what the script is doing. If it’s downloading files or establishing a C2 channel, that’s a red flag.”_

She proceeded to Step 2
#### 📜 Step 2: Decoding the Script

She exported the log entry and decoded the base64 command. It attempted to download a file from a suspicious IP address using `Invoke-WebRequest` and write it to `C:\Users\Public\Downloads\payload.ps1`.

At this point, she knew this wasn’t an admin running a legit script—it was malware deployment.

#### 🕵️‍♀️ Step 3: Log Correlation

To verify the attacker’s path, Riya switched over to the **Security logs** in Event Viewer and filtered by **Event ID 4624** (successful logon). She noticed a logon from a foreign IP address—one that didn’t match her company's geo profile.

She correlated this with:

- **Event ID 4672**: An account was granted **admin privileges**.
- **Event ID 7045**: A **new service** had been installed.
- **Event ID 1102**: Someone tried to **clear the event logs** (log tampering).
    

#### 🔎 Step 4: Registry and Services Check

Riya used her company’s **Sysinternals toolkit** via remote shell:

- Ran `sigcheck` on `C:\Windows\System32\` and found an **unsigned DLL** recently dropped.
- Used `TCPView` to find outbound connections from the host to the same IP as in the PowerShell script.
- Ran `Process Explorer` to confirm that **svchost.exe** was spawning **non-standard child processes**—clear evidence of process injection.
    

#### 📈 Step 5: Reporting & Containment

She documented:
- The **initial access vector** (PowerShell script from unknown source).
- The **user account used** and its abnormal behavior.
- Evidence of **privilege escalation**, **lateral movement**, and **persistence** attempts.
    
She initiated containment via the EDR tool, **isolated the host**, and alerted the Tier 2 team.

### 💡 Key Takeaways

Here’s how **Windows Event Logs & Event Viewer** helped Riya:

- **Event ID 4104**: Showed script content.
- **Security Logs (4624, 4672, 7045, 1102)**: Tracked attacker movements.
- **Event Viewer Filtering**: Quickly narrowed thousands of logs to the most critical.
- **Sysinternals Tools**: Validated findings with forensic depth.
- **Log Rotation Awareness**: Ensured logs weren’t wiped beyond recovery.
    
**This one alert opened a whole narrative, and the Windows Event Logs were the storybook.** For any SOC analyst, mastering these logs is like learning to read the enemy’s handwriting.

---
## 📝 `wevtutil.exe` – Windows Events Command-Line Utility
### 🔧 What is wevtutil.exe?
`wevtutil.exe`  is a command-line tool that allows users to:
- Retrieve information about event logs and publishers.
- Install/uninstall event manifests.
- Run queries.
- Export, archive, or clear event logs.

### 🧰 Basic Syntax
```bash
wevtutil COMMAND [ARGUMENTS] [/OPTION:VALUE]
```

### 📜 Common Commands
| Command | Full Name           | Description                          |
|---------|---------------------|--------------------------------------|
| el      | enum-logs           | List all log names.                  |
| gl      | get-log             | Get configuration of a log.         |
| sl      | set-log             | Modify log configuration.           |
| ep      | enum-publishers     | List all event publishers.          |
| gp      | get-publisher       | Get publisher configuration.        |
| im      | install-manifest    | Install a manifest.                 |
| um      | uninstall-manifest  | Uninstall a manifest.               |
| qe      | query-events        | Query events from a log or log file.|
| epl     | export-log          | Export logs to a file.              |
| cl      | clear-log           | Clear a log.                        |


### ⚙️ Common Options
| Option | Description                                      |
|--------|--------------------------------------------------|
| /r     | Remote machine name.                             |
| /u     | Username for remote login.                       |
| /p     | Password for the user.                           |
| /a     | Authentication type (Negotiate, Kerberos, etc.)  |
| /uni   | Unicode output (true or false).                  |


### 📖 Helpful Tips
- Use wevtutil COMMAND /? for help with a specific command.
- Example: To query events from the PowerShell log:
```powershell
wevtutil qe Microsoft-Windows-PowerShell/Operational /q:"*
[System[(EventID=4104)]]"
```

- Use /f:text to get results in plain text:
```powershell
wevtutil qe Microsoft-Windows-PowerShell/Operational /q:"*[System[(EventID=4104)]]" /f:text
```

- Use /c:N to limit output to N results:
```powershell
wevtutil qe Microsoft-Windows-PowerShell/Operational /c:5 /f:text
```

### 📚 Story: "Log Overload and the Analyst's Saviour"
Sam, a new SOC analyst, got a detection alert from the SIEM on a Friday morning:
>"Suspicious PowerShell activity (Event ID 4104) on an HR workstation."

He launched Event Viewer, browsed to PowerShell Operational logs, and... boom! Thousands of events stared back at him. Scrolling endlessly wasn’t scalable.

Over coffee, his team lead dropped a suggestion:
>“Use wevtutil. Script it and get only what you need.”

Sam launched a terminal and typed:

```powershell
wevtutil qe Microsoft-Windows-PowerShell/Operational /q:"*[System[(EventID=4104)]]" /f:text
```

Bingo. He now had just the relevant script logs and nothing else. Within seconds, Sam spotted an encoded base64 payload from an attacker trying to run a reverse shell.

He exported those logs:

```powershell
wevtutil epl Microsoft-Windows-PowerShell/Operational HR_4104_logs.evtx
```
... and attached them to the incident report.

From drowning in noise to extracting evidence in seconds, Sam discovered how wevtutil turned log chaos into clarity — a true SOC superpower.

---

## 🧠 `Get-WinEvent` PowerShell Cmdlet

### 📌 Overview

- `Get-WinEvent` retrieves logs from local or remote Windows systems.
- It **replaces** the older `Get-EventLog` cmdlet.
- Supports:
    - HashTable filtering
    - XPath queries
    - Structured XML filtering
        
### 📘 Syntax

```powershell
Get-WinEvent [-ListLog *]            # List all logs 
Get-WinEvent [-ListProvider *]       # List all providers 
Get-WinEvent -LogName 'Application'  # Read specific log 
Get-WinEvent -FilterHashtable @{LogName='XYZ'; ID=123}  # Precise filter`
```

### 🛠 Examples

#### 1. List all logs

```powershell
Get-WinEvent -ListLog *
```

#### 2. List event providers & associated logs
```powershell
Get-WinEvent -ListProvider *
```

#### 3. Filter logs using `Where-Object`
```powershell
Get-WinEvent -LogName Application | Where-Object { $_.ProviderName -Match 'WLMS' }
```

#### 4. Filter using `FilterHashtable` (preferred method)
```powershell
Get-WinEvent -FilterHashtable @{   LogName = 'Application'   ProviderName = 'WLMS' }
```

#### 5. Advanced Filter (PowerShell logs, Event ID 4104, look for `SecureString`)
```powershell
Get-WinEvent -FilterHashtable @{   LogName = 'Microsoft-Windows-PowerShell/Operational'   ID = 4104 } | Select-Object -Property Message | Select-String -Pattern 'SecureString'
```

### 🎯 Notes on HashTable Syntax

```powershell
@{ <Key> = <Value>; <Key> = <Value> }
```

- No semicolon needed if keys are on new lines
- Helpful keys:
    - `LogName`
    - `ProviderName`
    - `ID`
    - `StartTime` / `EndTime`
    - `Data`
    - `UserID`
    - `Keywords`
        

### 📚 Real-Life Story: The Sneaky Script

Sam, a Level 1 SOC Analyst, was alerted to **suspicious PowerShell behavior** on an executive's machine.
The alert said:
> "PowerShell script executed from an obfuscated path – needs investigation."

Instead of diving blindly into **Event Viewer**, Sam fired up PowerShell and used:
```powershell
Get-WinEvent -FilterHashtable @{   LogName = 'Microsoft-Windows-PowerShell/Operational'   ID = 4104 } | Select-Object -Property Message | Select-String -Pattern 'SecureString'
```

He instantly pulled every PowerShell command that **handled secure strings**—a known behavior in credential theft attacks.
Bingo! A **base64-encoded** payload using `ConvertTo-SecureString` was captured from the logs. The timestamp matched the alert.
Sam then queried the source application log using:
```powershell
Get-WinEvent -FilterHashtable @{   LogName = 'Application'   ProviderName = 'MsiInstaller' }
```

There it was—a rogue `.msi` silently installed moments before the PowerShell script ran.
Thanks to `Get-WinEvent`, Sam:
- Avoided sifting manually through thousands of logs
- Correlated app install to PowerShell abuse
- Identified attacker tactics within minutes
    
**End Result:** Sam escalated the incident with full evidence, and the IR team blocked similar MSI installs across the org.

---
## 🔍 Windows Event Log Filtering with XPath (Obsidian Format)

### 📌 What is XPath?
- **XPath (XML Path Language)** is a query language for selecting nodes from XML documents.
- Supported by **Windows Event Logs** for advanced filtering.
- Windows Event Log XPath is based on **XPath 1.0 subset**.
    
### 🧠 Basic XPath Query Structure
```xpath
*[System[(Level <= 3) and TimeCreated[timediff(@SystemTime) <= 86400000]]]
```

- Gets events from logs:
    - Severity level ≤ 3
    - Within the last 24 hours (in ms)
        

### 🔧 Building an XPath Query Step-by-Step

#### 🪜 From Event Viewer
1. Open Event Viewer → select an event → **Details tab → XML View**
2. Start from:  -  `*`
3. Traverse the XML tree: - `*/System/EventID=100`
    

#### ✅ Example Command (PowerShell)
```powershell
Get-WinEvent -LogName Application -FilterXPath '*/System/EventID=100'
```

### 🛠 Querying with XPath Attributes

#### Filter by Provider Name:
```powershell
`Get-WinEvent -LogName Application -FilterXPath '*/System/Provider[@Name="WLMS"]'`
```
#### Combine Event ID and Provider:
```powershell
`Get-WinEvent -LogName Application -FilterXPath '*/System/EventID=101 and */System/Provider[@Name="WLMS"]'`
```

### 📌 EventData XPath Queries

#### Filter Based on `EventData` Field (e.g., `TargetUserName`)
```powershell
`Get-WinEvent -LogName Security -FilterXPath '*/EventData/Data[@Name="TargetUserName"]="System"' -MaxEvents 1`
```

### 📄 `wevtutil.exe` XPath Usage

#### Query Using `wevtutil`
```powershell
`wevtutil.exe qe Application /q:"*/System[EventID=100]" /f:text /c:1`
```

- `/f:text` – Output in plain text
- `/c:1` – Limit result to 1 event
    
### 📚 XPath Tips for Analysts

- Use `*` or `Event` as the root tag
- Use `System` for metadata (EventID, Provider, Time)
- Use `EventData` for custom fields (e.g., usernames, IPs)
- XPath in `Get-WinEvent` and `wevtutil.exe` is **case-sensitive**
- Use `-MaxEvents` to limit output
    

### 🛡 Real-World Use Case (SOC Analyst)

 A SOC analyst receives an alert of repeated logins using the **SYSTEM account**. Instead of using the Event Viewer GUI, he uses Get-WinEvent with Xpath :
 
```powershell
 `Get-WinEvent -LogName Security -FilterXPath '*/EventData/Data[@Name="TargetUserName"]="System"'`
```
 
 This immediately pulls only those logs, revealing a script-runner mimicking SYSTEM logons. The analyst pivots into further 4624/4672 logs and confirms lateral movement.

---

