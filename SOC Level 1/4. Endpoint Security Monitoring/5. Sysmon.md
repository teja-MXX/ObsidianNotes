# 🛡️ Sysmon Overview for SOC Analysts

## What is Sysmon?
**Sysmon** (System Monitor) is a Windows system service and device driver that logs detailed system activity to the Windows Event Log. It's essential for endpoint detection and response (EDR) and SIEM pipelines.

- **Logs stored at**: `Applications and Services Logs > Microsoft > Windows > Sysmon > Operational`
- **Config required**: XML-based file defining rules (include/exclude logic)
- **Used with**: SIEMs, WEC (Windows Event Collection), and threat-hunting tools

## 📄 Configuration Philosophy
- **SwiftOnSecurity**: Exclude-based → reduce noise
- **ION-Storm**: Include-based → catch more signals
- **Pro Tip**: Tailor the config based on your network baseline and use cases.

## 🔍 Commonly Used Sysmon Event IDs

### 🧠 Event ID 1 – Process Creation
Logs every new process along with:
- `CommandLine`
- `Image`

#### Sample Config
```xml
<ProcessCreate onmatch="exclude">
  <CommandLine condition="is">C:\Windows\System32\svchost.exe -k appmodel</CommandLine>
</ProcessCreate>
```

### 🌐 Event ID 3 – Network Connection

Captures outbound connections made by processes:
- `Image`
- `DestinationPort`

#### Sample Config
```xml
<NetworkConnect onmatch="include">   <Image condition="image">nmap.exe</Image>   <DestinationPort condition="is">4444</DestinationPort> </NetworkConnect>
```

### 🧬 Event ID 7 – Image Load

Monitors DLLs loaded by processes (use with caution due to high noise):

- `ImageLoaded`
- `Signed`
- `Signature`
    
#### Sample Config
```xml
<ImageLoad onmatch="include">   <ImageLoaded condition="contains">\Temp\</ImageLoaded> </ImageLoad>
```

### 🧩 Event ID 8 – CreateRemoteThread

Detects code injection between processes:

- `SourceImage`
- `TargetImage`
- `StartAddress`
    
#### Sample Config
```xml
<CreateRemoteThread onmatch="include">   <StartAddress condition="end with">0B80</StartAddress> </CreateRemoteThread>
```

### 📁 Event ID 11 – File Create

Logs file creation on disk:
- `TargetFilename`
    
#### Sample Config
```xml
<FileCreate onmatch="include">   <TargetFilename condition="contains">HELP_TO_SAVE_FILES</TargetFilename> </FileCreate>
```

### 🧠 Event ID 12 / 13 / 14 – Registry Events

Monitors registry writes (useful for persistence):
- `TargetObject`
    
#### Sample Config
```xml
<RegistryEvent onmatch="include">   <TargetObject condition="contains">Windows\System\Scripts</TargetObject> </RegistryEvent>
```


### 💾 Event ID 15 – Alternate Data Streams (ADS)

Logs file creation in alternate data streams (e.g., hidden malware):

- `TargetFilename`
    
#### Sample Config
```xml
<FileCreateStreamHash onmatch="include">   <TargetFilename condition="end with">.hta</TargetFilename> </FileCreateStreamHash>
```

### 📡 Event ID 22 – DNS Query

Logs all DNS queries (common in malware beaconing):

- `QueryName`
    

#### Sample Config
```xml
<DnsQuery onmatch="exclude">   <QueryName condition="end with">.microsoft.com</QueryName> </DnsQuery>
```

## 🧰 Useful Sysmon Config Repositories

- [SwiftOnSecurity Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config)
- [ION-Storm Fork (Aggressive detection)](https://github.com/ion-storm/sysmon-config)
    
## 🧭 Analyst Tips

- Deploy Sysmon with a config at scale using GPO or deployment tools.
- Integrate Sysmon logs into a SIEM for threat detection rules.
- Tailor rules: Exclude noise (e.g., system files), include high-signal behaviors (e.g., PowerShell + encoded commands).
- Hunt by combining:
    - EID 1 + CommandLine anomalies
    - EID 3 + uncommon destinations
    - EID 22 + strange domain patterns
        
---

# 🚨 Sysmon: Malicious Activity Overview for SOC Analysts

## 🎯 Objective
Sysmon helps eliminate noise by filtering out normal behavior and surfacing **meaningful, suspicious events**. In this section, we cover how to use Sysmon to detect:
- 🔐 Ransomware
- 🛠️ Persistence
- 🧪 Mimikatz
- 📡 Metasploit
- 🕵️‍♂️ Command and Control (C2) beacons


## ✅ Sysmon Best Practices

### 1. **Exclude > Include**
- Exclude known-good behavior to reduce noise
- Avoid overly strict includes which may miss unknown threats

### 2. **Leverage CLI Tools**
- Use `Get-WinEvent` or `wevtutil.exe` for granular event filtering
- Preferred over GUI for automation and scale

### 3. **Know Your Environment**
- Baseline normal behavior (e.g., ports, processes, registry paths)
- Customize your configuration accordingly


## 🔍 Filtering Events

### 📁 With Event Viewer (GUI)
**Limited control**
- Use: `Actions > Filter Current Log`
- Filters:
  - **EventID** (e.g., 3 for network)
  - **Keywords**
  - **XML (optional)** – not scalable


### 💻 With PowerShell (Recommended)
**Full control and scalability**

#### 🔹 Basic XPath Filters:
| Goal | XPath Filter |
|------|--------------|
| Filter by Event ID | `*/System/EventID=3` |
| Filter by XML Attribute | `*/EventData/Data[@Name="DestinationPort"]` |
| Filter by Event Data | `*/EventData/Data=4444` |

#### 🔹 Combined Filter Example:
Search for Sysmon Event ID 3 (network connection) **to port 4444 (Metasploit C2)**
```powershell
Get-WinEvent -Path "C:\Users\Analyst\Desktop\Scenarios\Practice\Hunting_Metasploit.evtx" `
-FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444'
```

## 🚩 Sample Threat Detection Use Cases

| Threat          | Sysmon Event ID | What to Look For                                                        |
| --------------- | --------------- | ----------------------------------------------------------------------- |
| 🔓 Mimikatz     | 10, 11, 12, 13  | Process injections, unusual memory access, named pipes                  |
| 📡 Metasploit   | 3, 1            | Outbound to port 4444, nmap.exe, or msfvenom payloads                   |
| 🕹️ Persistence | 13, 14          | Suspicious registry changes (e.g., scripts in `Windows\System\Scripts`) |
| 🔐 Ransomware   | 11              | Files like `HELP_TO_SAVE_FILES`, mass file creation                     |
| 🧠 C2 Beacons   | 3, 22           | Repeated DNS to strange domains, outbound connections to rare IPs       |

## 🛡️ Optimization Tips

- **Tag known safe behaviors** (exclusions) to reduce alerts
- **Test configurations** on staging machines before production deployment
- **Automate** parsing and enrichment via your SIEM for alerting

## 🕵️‍♂️ **A Day in the Life of a SOC Analyst: The Sysmon Chronicles**

It’s 8:45 AM and Asha, a junior SOC analyst, has just settled in with her coffee when the SIEM dashboard lights up with a red alert:

> 🔔 _Unusual outbound connection to port 4444 from an internal workstation._

"Port 4444... that's sketchy," she thinks, remembering from training that this is often used by **Metasploit reverse shells**.

She quickly pivots to the endpoint logs. Thankfully, the machines in her company run **Sysmon with a custom config**. The rules were designed to **exclude normal traffic** and **include only known suspicious behaviors**. One of those rules specifically watches for:
```xml
<DestinationPort name="Alert,Metasploit" condition="is">4444</DestinationPort>
```
Asha opens PowerShell and runs:
```powershell
Get-WinEvent -Path "C:\Logs\Endpoint01.evtx" ` -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444'
```

Boom. There it is. A network connection from **notepad.exe** to an external IP on port 4444. That’s odd — Notepad doesn’t talk to the internet.

Curious, she runs another query:
```powershell
Get-WinEvent -Path "C:\Logs\Endpoint01.evtx" ` -FilterXPath '*/System/EventID=1 and */EventData/Data[@Name="Image"] and */EventData/Data="C:\Windows\System32\notepad.exe"'
```


She finds that Notepad was **spawned by an unknown binary** in `C:\Temp\`. Something named `svch0st.exe` — a clear **misspelling of svchost.exe**, often used in masquerading attacks.

The breadcrumbs start falling into place. She searches for **DLLs loaded** by that fake process:
```xml
<ImageLoaded condition="contains">\Temp\</ImageLoaded>
```


Sysmon Event ID 7 catches a suspicious DLL being loaded from that same `Temp` folder. Something isn’t right.

Then she checks **Event ID 22 — DNS queries**:
```xml
<QueryName condition="end with">.xyz</QueryName>
```
The fake process had also queried a strange domain ending in `.xyz` several times — likely a **C2 beacon**.

Finally, to assess damage, she checks if any **files were created** in sensitive directories using:
```xml
<TargetFilename name="Alert,Ransomware" condition="contains">HELP_TO_SAVE_FILES</TargetFilename>
```

Luckily, there’s **no sign of ransomware** — yet.

## 🔚 Wrapping Up

Asha:

- Confirms the host is **compromised via a reverse shell**.
- Alerts the **IR team** to isolate the system.
- Uses **SDelete** to clear any leftover malware, knowing it’s a secure wiping tool.
- Documents the incident and flags the IOC (Indicators of Compromise) — port 4444, fake svch0st.exe, and the suspicious `.xyz` domain.
    
Thanks to **Sysmon’s configuration**, CLI filtering, and her awareness of **normal vs. suspicious behavior**, Asha prevented a major breach.

The coffee may be cold now, but she just kept the company safe.

---

# 🧾 Hunting Metasploit with Sysmon

## 🔍 Goal:

Detect suspicious activity related to Metasploit Meterpreter payloads using Sysmon and PowerShell.

## 🔢 Event ID to Monitor:

- **Event ID 3** – `NetworkConnect`
    - Triggered when a connection is initiated.
    - Focus on commonly abused ports: `4444`, `5555`, etc.
        

## 🛠 Sysmon Config Snippet:
```xml
<RuleGroup name="" groupRelation="or"> 	<NetworkConnect onmatch="include"> 		<DestinationPort condition="is">4444</DestinationPort> 		<DestinationPort condition="is">5555</DestinationPort> 	</NetworkConnect> </RuleGroup>
```


## 🧪 PowerShell Hunting Command:
```xml
Get-WinEvent -Path "<PathToLog>" -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444
```

- Filters logs from file using:
    - `EventID=3`: Network Connect
    - XPath: looks for `DestinationPort=4444`
        

## 📁 Practical Use Case:

- Useful in detecting RATs, C2s, or initial access payloads like:
    - Metasploit Meterpreter
    - Empire, Cobalt Strike

## 💡 Tips:

- Combine with Event ID 1 (Process Creation) for better context.
- Look for unsigned binaries, uncommon parent-child relationships, suspicious command line arguments.
- Know the **normal traffic** in your environment — unexpected connections on known-malicious ports stand out.


## 🕵️‍♂️ Story: The Curious Case of the Silent Shell

It was just another quiet Tuesday in the SOC room. Alerts had been low, dashboards calm, and coffee was brewing. Arjun, a junior SOC analyst, was wrapping up his shift when he noticed something odd in the threat hunting dashboard. A log file from one of the monitored machines had been flagged during the routine Sysmon check.

The detection came from **Event ID 3** – a **network connection** event. Sysmon had logged a connection to port `4444`. Arjun’s eyebrows raised. He knew from experience — and his **MITRE ATT&CK** training — that this port was commonly used by **Metasploit's Meterpreter payload**.

Instead of relying on the noisy GUI of Event Viewer, he fired up PowerShell and typed:
```powershell
Get-WinEvent -Path "C:\Logs\Hunting_Metasploit.evtx" -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444'
```


The output confirmed his suspicion — the connection was made by a process called `payload.exe`, spawned from an odd-looking parent `wordhelper.exe`. It wasn’t signed, and the path was buried in a user’s temp folder.

Arjun knew this wasn’t normal. He pivoted from the network event to **process creation logs (Event ID 1)** and confirmed the process lineage. Sure enough, it matched the TTPs of a staged Metasploit payload.

He tagged the alert, notified his senior, and submitted a containment ticket for the affected host.

The lesson? **Know your ports. Know your logs. And know what’s normal in your environment.**

---

# 📝 Detecting Mimikatz Activity

## 📌 Overview

- **Mimikatz** is a post-exploitation tool that dumps credentials, especially by accessing the **LSASS** process.
- Threat actors may use **obfuscation** or **droppers** to bypass AV.
- Hunting Mimikatz focuses on **file creation**, **abnormal LSASS access**, and **process injections**.

## 🔍 Technique 1: Detecting File Creation

#### Use Case:

- Look for file names containing `mimikatz` to detect poorly obfuscated or misconfigured attacks.
    
### Sysmon Config Snippet:
```xml
<RuleGroup name="" groupRelation="or"> 	<FileCreate onmatch="include"> 		<TargetFileName condition="contains">mimikatz</TargetFileName> 	</FileCreate> </RuleGroup>
```

⚠️ This method is basic and may generate false positives. Use when bypassing AV is suspected.


## 🔍 Technique 2: Detecting Abnormal LSASS Behavior

### Use Case:
- Detect if a process other than `svchost.exe` is accessing `lsass.exe`.
    
### Sysmon Event ID:
- **Event ID 10**: Process Access

### Initial Sysmon Config:
```xml
<RuleGroup name="" groupRelation="or"> 	<ProcessAccess onmatch="include"> 	       <TargetImage condition="image">lsass.exe</TargetImage> 	</ProcessAccess> </RuleGroup>
```
### Problem:
- Too many normal logs from `svchost.exe` accessing `lsass.exe`.
    
### Refined Config to Reduce Noise:
```xml
<RuleGroup name="" groupRelation="or"> 	<ProcessAccess onmatch="exclude"> 		<SourceImage condition="image">svchost.exe</SourceImage> 	</ProcessAccess> 	<ProcessAccess onmatch="include"> 		<TargetImage condition="image">lsass.exe</TargetImage> 	</ProcessAccess> </RuleGroup>
```

✅ This filters out trusted behavior and focuses on anomalies.


## 🧪 PowerShell Detection with XPath

#### PowerShell Command:
```powershell
Get-WinEvent -Path "C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Hunting_Mimikatz.evtx" `   -FilterXPath '*/System/EventID=10 and */EventData/Data[@Name="TargetImage"] and */EventData/Data="C:\Windows\system32\lsass.exe"
```

-  Filters logs for processes accessing `lsass.exe`
- Combine with exclusion logic for better precision
    


## 📖 Story: “The Curious Case of the Quiet Intruder”

Sanya, a junior SOC analyst on night shift, spotted a spike in alerts from the SIEM. At first glance, they looked like ordinary process accesses. But something about the logs felt off. The usual suspects like `svchost.exe` were all over the place—nothing unusual there.

But Sanya had recently studied how Mimikatz targets **lsass.exe**. She remembered a trick from a Sysmon training: if something besides `svchost.exe` touches `lsass.exe`, dig deeper.

She wrote a quick filter using `Get-WinEvent`, targeting Event ID 10 and isolating processes accessing `lsass.exe`—excluding the usual trusted ones.

```powershell
Get-WinEvent -Path "Hunting_Mimikatz.evtx" `   -FilterXPath '*/System/EventID=10 and */EventData/Data[@Name="TargetImage"] and */EventData/Data="C:\Windows\system32\lsass.exe"
```

One entry stood out. A shady executable from a temp folder had reached into LSASS. It wasn’t signed. It wasn’t svchost.exe. It was… `mimkatz.exe`.

Sanya cross-checked the path. It didn’t belong. She checked the hash, uploaded it to VirusTotal, and confirmed it: a credential dumper that slipped past AV.

Thanks to her config’s noise reduction and her solid understanding of **Sysmon + PowerShell**, she caught the attack early—before any real damage was done.

That night, she wasn’t just a junior analyst. She was the firewall between a quiet intrusion and a major breach.

---

# 🧠 Hunting Malware (RATs & Backdoors) with Sysmon

## 🧾 Overview

- Focus: **RATs (Remote Access Trojans)** and **Backdoors**
- RATs = Remote access + admin-like interface + persistence
- Examples: **Xeexe**, **Quasar**, often include AV evasion
- Technique: **Hypothesis-based hunting** — define your detection hypothesis, then tune Sysmon configs to catch it
    

## 🔍 Technique: Hunting Suspicious Back-Connect Ports

### Goal
Detect **RAT activity** by identifying outbound network connections to **unusual ports** (e.g., `1034`, `1604`, `8080`).

### Sample Sysmon Config Snippet (Ion-Storm Based)
```xml
<RuleGroup name="" groupRelation="or"> 	<NetworkConnect onmatch="include"> 		<DestinationPort condition="is">1034</DestinationPort> 		<DestinationPort condition="is">1604</DestinationPort> 	</NetworkConnect> 	<NetworkConnect onmatch="exclude"> 		<Image condition="image">OneDrive.exe</Image> 	</NetworkConnect> </RuleGroup>
```

🟡 **⚠ Be Cautious**: Don't blindly exclude ports like `53` — attackers may use DNS tunneling.

## 🧪 PowerShell Command to Filter Logs

#### Use `Get-WinEvent` with XPath:
```powershell
Get-WinEvent -Path "C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Hunting_Rats.evtx" `   -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=8080
```
### Breakdown:
- `EventID=3`: Sysmon Network Connection
- `DestinationPort=8080`: Common RAT port
- Filters RAT beacon activity in event logs
    
## 🧼 Best Practices for Hunting RATs with Sysmon

|Practice|Why It Matters|
|---|---|
|**Exclude > Include**|Reduces noise while ensuring visibility|
|**Know your environment**|Prevents false positives/negatives|
|**Use CLI over GUI**|Allows precision + scripting|
|**Custom port list awareness**|Avoid missing clever backdoor configs|

🔗 Refer to: [Malware Common Ports Spreadsheet](https://github.com/fireeye/red_team_tool_countermeasures/blob/master/the_common_ports_spreadsheet.csv) for known bad ports.

## 📖 Real-World Story: “The 4AM Ping”

It was quiet in the SOC, the hum of fans and dashboards the only sound. Arjun, a new L2 analyst, was running final shift validation on the day’s alerts. His screen lit up with outbound traffic alerts—**port 8080**. No big deal?

He remembered his training. Port 8080 was common… but not in _their_ environment.

A quick PowerShell script filtered Sysmon logs for `EventID 3` and `DestinationPort 8080`. Five hits. All from the same machine. All spaced every five seconds. A **heartbeat beacon**.

He cross-referenced the process name—**not OneDrive.exe**, but a strange binary named `svch0st.exe` (note the zero). Definitely **not** the real `svchost.exe`.

With the hash uploaded to VirusTotal, the verdict was instant: a custom build of **Xeexe RAT**.

Within 30 minutes, the system was isolated. They pulled memory dumps. Incident declared. And Arjun? He wasn't just doing shift validation anymore—he was credited for stopping a full-blown breach.

---
# 🛡️ Hunting Persistence with Sysmon

## 🧾 Overview

- **Goal:** Detect attacker _persistence techniques_ using Sysmon
- **Common Techniques:**
    - Registry modification
    - File dropped in `Startup` or `Start Menu`    
- **Event Types Used:**
    - `FileCreate` (Event ID 11)
    - `RegistryEvent` (Event IDs 12, 13, 14)
- **Config Base:** [SwiftOnSecurity Sysmon config](https://github.com/SwiftOnSecurity/sysmon-config)
- 📂 Event logs used:
    - `T1023.evtx` – Startup folder persistence
    - `T1060.evtx` – Registry Run key persistence

## 📁 File-Based Persistence

### MITRE ATT&CK ID: T1547 (Startup Folder)

Sysmon monitors file creation under:
- `C:\Users\<User>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\`
- `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`

### Sysmon Config Snippet

```xml
<RuleGroup name="" groupRelation="or"> 	<FileCreate onmatch="include"> 		<TargetFilename name="T1023" condition="contains">\Start Menu</TargetFilename> 		<TargetFilename name="T1165" condition="contains">\Startup\</TargetFilename> 	</FileCreate> </RuleGroup>
```

### How to Investigate:

- Review the event's `Image`, `CommandLine`, and `ParentImage`
- Check timestamp and session info
- Analyze the binary with AV or hash lookups (e.g., VirusTotal)
    
## 🧬 Registry-Based Persistence

### MITRE ATT&CK ID: T1060 (Registry Run Key)

Common keys used:

- `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- `Group Policy\Scripts`

### Sysmon Config Snippet
```xml
<RuleGroup name="" groupRelation="or"> 	<RegistryEvent onmatch="include"> 		<TargetObject name="T1060,RunKey" condition="contains">CurrentVersion\Run</TargetObject> 		<TargetObject name="T1484" condition="contains">Group Policy\Scripts</TargetObject> 		<TargetObject name="T1060" condition="contains">CurrentVersion\Windows\Run</TargetObject> 	</RegistryEvent> </RuleGroup>
```

### Registry Key to Check:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Persistence Value: %windir%\System32\malicious.exe`

## 🧪 PowerShell Filtering (Optional)

Use PowerShell to quickly filter logs for suspicious persistence indicators:
### Example – Filter for Registry Key Modification
```powershell
Get-WinEvent -Path "C:\Path\To\T1060.evtx" ` -FilterXPath '*/System/EventID=13 and */EventData/Data[@Name="TargetObject"] and contains(., "CurrentVersion\\Run")'
```

### Example – Filter for Startup Folder File Creation
```powershell
Get-WinEvent -Path "C:\Path\To\T1023.evtx" ` -FilterXPath '*/System/EventID=11 and */EventData/Data[@Name="TargetFilename"] and contains(., "Startup")'
```

## 🧠 Key Takeaways for SOC Analysts

| Technique        | Event ID | Action                                          |
| ---------------- | -------- | ----------------------------------------------- |
| File in Startup  | 11       | Investigate EXE creation in `Startup` paths     |
| Reg Key Modified | 13       | Look for values added to `CurrentVersion\Run`   |
| RuleName Filter  | N/A      | Use `T1023` / `T1060` in Event Viewer to filter |

## 📖 SOC Story: _The Curious Case of "persist.exe"_

During a slow Wednesday shift, junior SOC analyst Nisha was skimming through daily logs. A new rule from the SwiftOnSecurity config had flagged a file called `persist.exe` created in the `Startup` folder. It sounded too obvious—almost _too_ obvious.

She opened up the corresponding `T1023.evtx` log in Event Viewer. There it was—an unsigned binary dropped at 3:02 AM.

Using VirusTotal, she quickly realized the hash had zero hits. Unusual. She pulled the registry hives and found a matching key in 
`HKLM\...\CurrentVersion\Run`, pointing to `%windir%\System32\malicious.exe`.

At that point, it clicked.

A simple persistence technique hidden behind a non-threatening name.

Before EDR had time to flag it, Nisha had already isolated the box, raised an incident alert, and neutralized the malware.

Lesson: Even the simplest techniques can fly under the radar. But not under a properly tuned Sysmon + a curious analyst.

---

# 🔎 Detecting Evasion Techniques (Sysmon)

## 📌 Overview

- **Goal:** Detect malware evasion techniques using Sysmon logs.
- **Focus Areas:**
    - Alternate Data Streams (ADS) → _Event ID 15_
    - Remote Thread Injection → _Event ID 8_
- **Tools:**
    - Sysmon + SwiftOnSecurity config
    - Event Viewer / PowerShell (`Get-WinEvent`)
    - Command line for ADS: `dir /r`
        

## 📁 1. Alternate Data Streams (ADS)

### 🎯 MITRE ID: T1564.004
Used to **hide malicious payloads** in hidden NTFS file streams.
### 🧪 Sysmon Detection
**Event ID:** 15 — `FileCreateStreamHash`
### 💡 Sample Config Snippet
```xml
<RuleGroup name="" groupRelation="or">   <FileCreateStreamHash onmatch="include">     <TargetFilename condition="contains">Downloads</TargetFilename>     <TargetFilename condition="contains">Temp\7z</TargetFilename>     <TargetFilename condition="ends with">.hta</TargetFilename>     <TargetFilename condition="ends with">.bat</TargetFilename>   </FileCreateStreamHash> </RuleGroup>
```
### 🧰 Command to List ADS

`dir /r`

Example Output:
`not_malicious.txt:malicious.txt:$DATA`

### 🧪 PowerShell Detection
```powershell
Get-WinEvent -Path "C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Hunting_ADS.evtx" -FilterXPath '*/System/EventID=15'
```

## 🧬 2. Remote Thread Injection

### 🎯 MITRE ID: T1055

Technique often used in:
- DLL Injection
- Process Hollowing
- Reflective PE Injection
    
### 🧪 Sysmon Detection
**Event ID:** 8 — `CreateRemoteThread`

### ⚙️ SwiftOnSecurity Config Snippet
```xml
<RuleGroup name="" groupRelation="or">   <CreateRemoteThread onmatch="exclude">     <SourceImage condition="is">C:\Windows\system32\svchost.exe</SourceImage>     <TargetImage condition="is">C:\Program Files (x86)\Google\Chrome\Application\chrome.exe</TargetImage>   </CreateRemoteThread> </RuleGroup>
```

### 💻 PowerShell to Detect Remote Threads
```powershell
Get-WinEvent -Path "C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Detecting_RemoteThreads.evtx" -FilterXPath '*/System/EventID=8'
```

### 🔍 What to Investigate:

- SourceImage (who injected)
- TargetImage (victim process)
- Timestamps and user context
- Parent processes
    
## 🧠 Quick Reference Table

|Technique|Event ID|What to Look For|
|---|---|---|
|Alternate Data Streams (ADS)|15|Files in `Downloads/Temp`, `.hta` or `.bat`|
|Remote Thread Injection|8|`powershell.exe` or other processes injecting into trusted apps like `notepad.exe`|

## 📖 SOC Story: _"The Notepad That Talked Back"_

**Context:**  
During a normal day shift, SOC analyst Arjun saw an alert from Sysmon’s Event ID 8: _CreateRemoteThread_. That’s usually fine… except this one had a twist:

- **Source:** `powershell.exe`
- **Target:** `notepad.exe`
    
Weird.

He used `Get-WinEvent` to confirm five such events occurred in the span of a second.
Next stop? Memory dump and deeper inspection.

What he found was textbook **Process Hollowing** — a trojanized payload injected into a clean `notepad.exe` process. Looking further, he traced it back to a file hidden in ADS — a `.bat` script disguised in `not_malicious.txt:dropper.bat`.

**Outcome:**  
Arjun contained the endpoint, triggered automated response actions, and documented a new evasion signature. His team added alerts for Event ID 8 involving PowerShell and common bait processes like `notepad.exe`.

**Lesson:**  
Knowing what to hunt and how to interpret Sysmon logs gave Arjun the edge. The malware tried to hide — but Sysmon and an alert analyst didn’t let it.

